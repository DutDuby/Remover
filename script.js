const imageUpload=document.getElementById("image-upload"),backgroundUpload=document.getElementById("background-upload"),originalImage=document.getElementById("original-image"),processedImage=document.getElementById("processed-image"),downloadButton=document.getElementById("download-button"),loadingSpinner=document.getElementById("loading-spinner"),errorMessage=document.getElementById("error-message"),themeToggleBtn=document.getElementById("theme-toggle-btn"),brightnessSlider=document.getElementById("brightness"),contrastSlider=document.getElementById("contrast"),saturationSlider=document.getElementById("saturation"),rotateSlider=document.getElementById("rotate"),blurSlider=document.getElementById("blur"),resetEnhancementBtn=document.getElementById("reset-enhancement"),copyCodeButton=document.getElementById("copy-code-button"),applyTextButton=document.getElementById("apply-text-button"),overlayTextInput=document.getElementById("overlay-text"),textSizeInput=document.getElementById("text-size"),textColorInput=document.getElementById("text-color"),textFontInput=document.getElementById("text-font"),textStyleInput=document.getElementById("text-style"),textOverlay=document.getElementById("text-overlay"),resetTextButton=document.getElementById("reset-text-button"),moveUpBtn=document.getElementById("move-up"),moveDownBtn=document.getElementById("move-down"),moveLeftBtn=document.getElementById("move-left"),moveRightBtn=document.getElementById("move-right");let textX=50,textY=50;const moveStep=5;let processedImageBlob=null;function initTheme(){const e=localStorage.getItem("theme")||"light";document.documentElement.setAttribute("data-theme",e)}function updateImageEnhancements(){const e=brightnessSlider.value,t=contrastSlider.value,n=saturationSlider.value,o=rotateSlider.value,a=blurSlider.value;processedImage.style.filter=`brightness(${e}%) contrast(${t}%) saturate(${n}%) blur(${a}px)`,processedImage.style.transform=`rotate(${o}deg)`}function resetEnhancements(){brightnessSlider.value=100,contrastSlider.value=100,saturationSlider.value=100,rotateSlider.value=0,blurSlider.value=0,updateImageEnhancements()}function updateTextPosition(){textOverlay.style.left=textX+"px",textOverlay.style.top=textY+"px"}function resetTextControls(){overlayTextInput.value="",textSizeInput.value=24,textColorInput.value="#000000",textFontInput.value="Arial",textStyleInput.value="normal",textOverlay.textContent="",textOverlay.style="",textX=50,textY=50,updateTextPosition()}function setupDragAndDrop(e,t){e.addEventListener("dragover",(t=>{t.preventDefault(),t.stopPropagation(),e.style.background="rgba(255, 255, 255, 0.2)",e.style.borderColor="rgba(255, 255, 255, 0.8)"})),e.addEventListener("dragleave",(t=>{t.preventDefault(),t.stopPropagation(),e.style.background="rgba(255, 255, 255, 0.1)",e.style.borderColor="rgba(255, 255, 255, 0.3)"})),e.addEventListener("drop",(n=>{n.preventDefault(),n.stopPropagation(),e.style.background="rgba(255, 255, 255, 0.1)",e.style.borderColor="rgba(255, 255, 255, 0.3)";const o=n.dataTransfer.files[0];o&&o.type.startsWith("image/")&&(t.files=n.dataTransfer.files,handleFileSelect(o,"image-upload"===t.id))}))}function handleFileSelect(e,t){if(e&&e.type.startsWith("image/")){const n=new FileReader;n.onload=n=>{t?(originalImage.src=n.target.result,removeBackground(e),resetEnhancements(),resetTextControls()):processedImageBlob&&(applyCustomBackground(processedImageBlob,n.target.result),resetEnhancements(),resetTextControls())},n.readAsDataURL(e)}}async function removeBackground(e){const t=new FormData;t.append("image_file",e),t.append("size","auto"),loadingSpinner.style.display="block",errorMessage.style.display="none";try{const e=await fetch("https://api.remove.bg/v1.0/removebg",{method:"POST",headers:{"X-Api-Key":"kGoWqUQEnZcWHM3yQFWibwiH"},body:t});if(!e.ok){const t=await e.text();throw new Error(`Failed: ${e.status} - ${t}`)}const n=await e.blob();processedImageBlob=n,processedImage.src=URL.createObjectURL(n),downloadButton.disabled=!1}catch(e){errorMessage.textContent="Error: "+e.message,errorMessage.style.display="block"}finally{loadingSpinner.style.display="none"}}function applyCustomBackground(e,t){const n=document.createElement("canvas"),o=n.getContext("2d"),a=new Image;a.src=URL.createObjectURL(e);const r=new Image;r.src=t,Promise.all([new Promise((e=>a.onload=e)),new Promise((e=>r.onload=e))]).then((()=>{n.width=a.width,n.height=a.height,o.drawImage(r,0,0,n.width,n.height),o.drawImage(a,0,0),processedImage.src=n.toDataURL()}))}function getImageShareURL(){return processedImage.src&&"#"!==processedImage.src?processedImage.src:(alert("Please process an image before sharing!"),null)}themeToggleBtn.addEventListener("click",(()=>{const e="light"===document.documentElement.getAttribute("data-theme")?"dark":"light";document.documentElement.setAttribute("data-theme",e),localStorage.setItem("theme",e)})),initTheme(),brightnessSlider.addEventListener("input",updateImageEnhancements),contrastSlider.addEventListener("input",updateImageEnhancements),saturationSlider.addEventListener("input",updateImageEnhancements),rotateSlider.addEventListener("input",updateImageEnhancements),blurSlider.addEventListener("input",updateImageEnhancements),resetEnhancementBtn.addEventListener("click",resetEnhancements),resetTextButton.addEventListener("click",resetTextControls),moveUpBtn.addEventListener("click",(()=>{textY-=5,updateTextPosition()})),moveDownBtn.addEventListener("click",(()=>{textY+=5,updateTextPosition()})),moveLeftBtn.addEventListener("click",(()=>{textX-=5,updateTextPosition()})),moveRightBtn.addEventListener("click",(()=>{textX+=5,updateTextPosition()})),document.querySelectorAll(".upload-box").forEach((e=>{const t=e.querySelector('input[type="file"]');e.addEventListener("click",(()=>t.click()))})),setupDragAndDrop(document.querySelector(".upload-box:not(.background-upload)"),imageUpload),setupDragAndDrop(document.querySelector(".background-upload"),backgroundUpload),imageUpload.addEventListener("change",(e=>handleFileSelect(e.target.files[0],!0))),backgroundUpload.addEventListener("change",(e=>handleFileSelect(e.target.files[0],!1))),applyTextButton.addEventListener("click",(()=>{textOverlay.textContent=overlayTextInput.value||"",textOverlay.style.fontSize=`${textSizeInput.value||24}px`,textOverlay.style.color=textColorInput.value||"#000000",textOverlay.style.fontFamily=textFontInput.value;const e=textStyleInput.value;textOverlay.style.fontWeight=e.includes("bold")?"bold":"normal",textOverlay.style.fontStyle=e.includes("italic")?"italic":"normal",updateTextPosition()})),copyCodeButton.addEventListener("click",(()=>{processedImage.src&&"#"!==processedImage.src?navigator.clipboard.writeText(processedImage.src).then((()=>{copyCodeButton.textContent="Copied!",setTimeout((()=>{copyCodeButton.textContent="Copy Image as Code"}),2e3)})).catch((e=>alert("Failed to copy: "+e))):alert("No processed image available to copy!")})),downloadButton.addEventListener("click",(()=>{const e=document.getElementById("download-format").value,t=parseInt(document.getElementById("download-resolution").value)||1,n=document.createElement("canvas"),o=n.getContext("2d"),a=new Image;a.src=processedImage.src,a.onload=()=>{n.width=a.width*t,n.height=a.height*t,o.scale(t,t),o.filter=processedImage.style.filter;const r=parseInt(rotateSlider.value)||0;if(o.translate(n.width/(2*t),n.height/(2*t)),o.rotate(r*Math.PI/180),o.drawImage(a,-a.width/2,-a.height/2),o.rotate(-r*Math.PI/180),o.translate(-n.width/(2*t),-n.height/(2*t)),""!==textOverlay.textContent.trim()){const e=textStyleInput.value,t=e.includes("bold")?"bold ":"",n=e.includes("italic")?"italic ":"";o.font=`${n}${t}${textSizeInput.value||24}px ${textFontInput.value}`,o.fillStyle=textColorInput.value,o.fillText(textOverlay.textContent,textX,textY)}let l="image/png",d="png";"jpg"===e&&(l="image/jpeg",d="jpg"),"webp"===e&&(l="image/webp",d="webp");const s=document.createElement("a");s.href=n.toDataURL(l,.95),s.download=`Background Dropper-${t}x.${d}`,s.click()}})),document.getElementById("share-facebook").addEventListener("click",(()=>{const e=getImageShareURL();if(e){const t=`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(e)}`;window.open(t,"_blank")}})),document.getElementById("share-twitter").addEventListener("click",(()=>{const e=getImageShareURL();if(e){const t=`https://twitter.com/intent/tweet?url=${encodeURIComponent(e)}&text=Check out my edited image!`;window.open(t,"_blank")}})),document.getElementById("share-linkedin").addEventListener("click",(()=>{const e=getImageShareURL();if(e){const t=`https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(e)}`;window.open(t,"_blank")}})),document.getElementById("share-whatsapp").addEventListener("click",(()=>{const e=getImageShareURL();if(e){const t=`https://api.whatsapp.com/send?text=Check out my edited image! ${encodeURIComponent(e)}`;window.open(t,"_blank")}})),document.querySelectorAll(".stock-item").forEach((e=>{e.addEventListener("click",(()=>{processedImageBlob?(applyCustomBackground(processedImageBlob,e.src),resetEnhancements(),resetTextControls()):alert("Please upload and process an image first!")}))})),document.querySelectorAll(".dynamic-item").forEach((e=>{e.addEventListener("click",(()=>{if(!processedImageBlob)return void alert("Please upload and process an image first!");const t=document.createElement("canvas"),n=t.getContext("2d"),o=new Image;o.src=URL.createObjectURL(processedImageBlob),o.onload=()=>{t.width=o.width,t.height=o.height;const a=e.dataset.bg;if("gradient"===a){const e=n.createLinearGradient(0,0,t.width,t.height);e.addColorStop(0,"#4f46e5"),e.addColorStop(1,"#3b82f6"),n.fillStyle=e,n.fillRect(0,0,t.width,t.height)}else if("moving"===a){n.fillStyle="black",n.fillRect(0,0,t.width,t.height);for(let e=0;e<200;e++)n.fillStyle=`rgba(255,255,255,${Math.random()})`,n.beginPath(),n.arc(Math.random()*t.width,Math.random()*t.height,2*Math.random(),0,2*Math.PI),n.fill()}else if("pattern"===a){n.fillStyle="#f4f4f4",n.fillRect(0,0,t.width,t.height),n.strokeStyle="#ccc";for(let e=0;e<t.width;e+=40)for(let o=0;o<t.height;o+=40)n.strokeRect(e,o,40,40)}n.drawImage(o,0,0),processedImage.src=t.toDataURL()}}))}));const bulkUploadInput=document.getElementById("bulk-upload-input"),bulkPreview=document.getElementById("bulk-preview");async function removeBackgroundBulk(e){const t=new FormData;t.append("image_file",e),t.append("size","auto");const n=await fetch("https://api.remove.bg/v1.0/removebg",{method:"POST",headers:{"X-Api-Key":"kGoWqUQEnZcWHM3yQFWibwiH"},body:t});if(!n.ok){const e=await n.text();throw new Error(`Failed: ${n.status} - ${e}`)}return await n.blob()}bulkUploadInput.addEventListener("change",(async e=>{const t=Array.from(e.target.files);bulkPreview.innerHTML="";for(const e of t){if(!e.type.startsWith("image/"))continue;const t=document.createElement("div");t.className="bulk-item",t.innerHTML=`<p>${e.name}</p><p>Processing...</p>`,bulkPreview.appendChild(t);try{const n=await removeBackgroundBulk(e),o=document.createElement("img");o.src=URL.createObjectURL(n),t.innerHTML=`<p>${e.name}</p>`,t.appendChild(o);const a=document.createElement("button");a.textContent="Download",a.addEventListener("click",(()=>{const t=document.createElement("a");t.href=o.src,t.download=`processed-${e.name}`,t.click()})),t.appendChild(a)}catch(n){t.innerHTML=`<p>${e.name}</p><p style="color:red;">Error: ${n.message}</p>`}}}));